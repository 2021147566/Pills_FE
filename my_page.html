<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>My Page | AL-I</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- <script src="mypage.js"></script>  -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script> -->
  </head>

  <body>
    <div class="bar">
      <a class="bar_left" href="main.html">
        <div class="logo">
          <img src="img/pill.png" alt="logo" width="80px" height="80px" />
        </div>
        <div class="title">
          <h1>AL-I</h1>
        </div>
      </a>
      <div class="bar_right">
        <!-- {% if not user.is_authenticated %} -->

        <a class="login" href="login.html">로그인</a
        ><!--href="/login"-->
        <a class="signup" href="signup.html">회원가입</a>
        <!-- href="/signup" -->

        <!-- {% else %} -->
        <a class="logout" href="logout.html">로그아웃</a
        ><!-- href="/logout" -->
        <a class="profile" href="my_page.html"
          ><!-- href="/profile/{{ user.username }}" -->
          <img
            class="bar_profile"
            src="img/profile.jpg"
            alt="profile"
          /><!-- src = "{{ user. profile }}" -->
        </a>
        <!-- {% endif %} -->
      </div>
    </div>
    <div class="profile_box">
      <div class="profile_img">
        <img
          src="img/profile.jpg"
          id="profile_img_mypage"
          alt="profile"
          width="200px"
          height="200px"
        />
        <button
          type="button"
          class="upload_btn_mypage"
          onclick="onClickUpload()"
          id="image_mypage"
          style="margin-top: 20px"
        >
          파일 업로드
        </button>
        <input
          id="upload_file"
          type="file"
          accept="image/*"
          onchange="loadFile(event)"
          style="visibility: hidden"
        />
        <script>
          function onClickUpload() {
            let myInput = document.getElementById("upload_file");
            myInput.click();
          }
          var loadFile = function (event) {
            var output = document.getElementById("profile_img_mypage");
            output.style.display = "";
            output.src = URL.createObjectURL(event.target.files[0]);
            output.onload = function () {
              URL.revokeObjectURL(output.src);
            };
          };
        </script>
      </div>
      <div class="profile_info">
        <h3>이메일: <span id="my_email"></span></h3>
        <h3>유저이름: <input id="update_username" /></h3>
        <h3>생년월일: <input type="date" id="update_birthday" /></h3>
        <div class="password_edit">
          <h4>비밀번호:</h4>
          <button
            type="button"
            class="password_btn_mypage"
            onclick="OpenModal()"
            id="password"
          >
            변경
          </button>
          <script>
            function OpenModal() {
              document.getElementById("myModal").style.display = "block";
            }
            function CloseModal() {
              document.getElementById("myModal").style.display = "none";
              document.getElementById("pres_password").value = "";
              document.getElementById("new_password").value = "";
              document.getElementById("new_password_check").value = "";
              document.getElementById("pw_update_errors").innerText = "";
              console.log("CloseModal");
            }
            function UpdatePassword() {
              CloseModal();
              console.log("UpdatePassword");
            }
            //email & username 가져오고 username 변경가능
            async function request() {
              const payload = localStorage.getItem("payload");
              const payload_parse = JSON.parse(payload);
              console.log(payload_parse.profile_img);
              const request_user_id = payload_parse.user_id;

              const response = await fetch(
                `http://127.0.0.1:8000/accounts/profile/${request_user_id}/`,
                {
                  method: "GET",
                  headers: {
                    Authorization: "Bearer " + localStorage.getItem("access"),
                  },
                }
              );
              const data = await response.json();
              console.log(data);

              document.getElementById(
                "my_profile_img"
              ).src = `http://127.0.0.1:8000${data.profile_img}/`;
              document.getElementById(
                "nav_profile_img"
              ).src = `http://127.0.0.1:8000${data.profile_img}/`;

              document.getElementById("my_email").innerText = data.email;
              document.getElementById("update_username").value = data.username;
              document.getElementById("update_birthday").value = data.birthday;
            }
          </script>
        </div>
      </div>
    </div>
    <button
      type="button"
      class="edit_btn_mypage"
      id="edit"
      onclick="handleUpdateProfile()"
    >
      수정
    </button>
    <div class="myModal" id="myModal">
      <div class="modal-content">
        <div class="modal-header">
          <span class="close" id="modalCloseButton" onclick="CloseModal()"
            >&times;</span
          >
          <h2>비밀번호 변경</h2>
        </div>
        <div class="modal-body">
          <form action="">
            <div class="form-group">
              <label for="password" class="modal_text"
                >현재 비밀번호 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label
              >
              <input
                type="password"
                class="form-control"
                id="pres_password"
                placeholder="현재 비밀번호를 입력하세요."
              />
            </div>
            <br />
            <div class="form-group">
              <label for="new_password" class="modal_text"
                >새 비밀번호
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label
              >
              <input
                type="password"
                class="form-control"
                id="new_password"
                placeholder="새 비밀번호를 입력하세요."
              />
            </div>
            <br />
            <div class="form-group">
              <label for="new_password_check" class="modal_text"
                >비밀번호 확인 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</label
              >
              <input
                type="password"
                class="form-control"
                id="new_password_check"
                placeholder="새 비밀번호를 다시 입력하세요."
              />
            </div>

            <span id="pw_update_errors" style="color: red"></span> <br />
            <button
              type="submit"
              class="btn btn-primary"
              onclick="UpdatePassword()"
            >
              변경
            </button>
          </form>
          <script>
            async function handleUpdateProfile() {
              console.log("sss");
              const payload = localStorage.getItem("payload");
              const payload_parse = JSON.parse(payload);
              const request_user_id = payload_parse.user_id;

              const formData = new FormData();

              formData.append(
                "username",
                document.getElementById("update_username").value
              );
              formData.append(
                "birthday",
                document.getElementById("update_birthday").value
              );
              if (document.getElementById("profile_img_mypage").files[0]) {
                formData.append(
                  "profile_img",
                  document.getElementById("profile_img_mypage").files[0]
                );
              }

              const response = await fetch(
                `http://127.0.0.1:8000/accounts/profile/${request_user_id}/`,
                {
                  method: "PUT",
                  headers: {
                    Authorization: "Bearer " + localStorage.getItem("access"),
                  },
                  body: formData,
                }
              );

              console.log(response);
              if (response.status == 200) {
                location.reload();
              } else if (response.status == 403) {
                const errorData = await response.json();
                document.getElementById("profile_update_errors").innerText =
                  errorData.message;
              } else {
                document.getElementById("profile_update_errors").innerText =
                  "회원정보 수정 실패.";
              }
            }
          </script>
        </div>
      </div>
    </div>
  </body>
</html>
